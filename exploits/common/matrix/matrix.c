#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <assert.h>

#include "matrix.h"

Matrix* create_matrix(int num_rows, int num_cols){
  Matrix* m = malloc(sizeof(Matrix));

  size_t num_bytes = num_rows * num_cols * sizeof(cell_type);
  m->data = malloc(num_bytes);
  clear_matrix(m);

  m->num_rows = num_rows;
  m->num_cols = num_cols;

  return m;
}

void free_matrix(Matrix* m){
  free(m->data);
  free(m);
}

cell_type get_value(Matrix* m, int row, int col) {
  return *(m->data + row * m->num_cols + col);
}

void set_value(Matrix* m, int row, int col, cell_type val) {
  *(m->data + row * m->num_cols + col) = val;
}

void inc_value(Matrix* m, int row, int col) {
  *(m->data + row * m->num_cols + col) += 1;
}

void copy_matrix(Matrix* src, Matrix* dst){
  int i, j;
  assert(src->num_rows == dst->num_rows);
  assert(src->num_cols == dst->num_cols);
  for (i=0; i < src->num_rows; i++) {
    for (j=0; j < src->num_cols; j++) {
      set_value(dst, i, j, get_value(src, i, j));
    }
  }
}

void clear_matrix(Matrix* m){
  size_t num_bytes = m->num_rows * m->num_cols * sizeof(cell_type);
  memset(m->data, 0, num_bytes);
}

uint32_t count_hits(Matrix* m, int16_t threshold){
  uint32_t count = 0;
  int i, j;
  for (i=0; i < m->num_rows; i++) {
    for (j=0; j < m->num_cols; j++) {
      if (get_value(m, i, j) >= threshold) {
        count += 1;
      }
    }
  }
  return count;
}

void print_matrix_csv(Matrix* m){
  int ri, ci;

  for (ci=0; ci < m->num_cols; ci++) {
    printf(",%d", ci);
  }
  printf("\n");

  for (ri=0; ri < m->num_rows; ri++) {
    printf("%d", ri);
    for (ci=0; ci < m->num_cols; ci++) {
      printf(",%d", get_value(m, ri, ci));
    }
    printf("\n");
  }
  printf("\n");
}

void print_matrix_xy(Matrix* x, Matrix* y) {
  int i, j;
  printf("========\n");
  for (i = 0; i < x->num_rows; i++) {
    for (j = 0; j < x->num_cols; j++) {
      printf("%d,%d,%d,%d\n", i, j, get_value(x, i, j), get_value(y, i, j));
    }
  }
  printf("========\n");
}

