APP_DIR := $(patsubst %/,%,$(dir $(abspath $(firstword $(MAKEFILE_LIST)))))
EVSETS_DIR := $(APP_DIR)/../../../evsets
KMOD_DIR := $(APP_DIR)/../../../kmod/

CFLAGS += -g -O2 -Wunused-variable -Wunused-function

all: libllc_prime_probe.so

libllc_prime_probe.so: llc_prime_probe.c llc_prime_probe.h calib.h $(KMOD_DIR)/libkmod_driver.so $(EVSETS_DIR)/libevsets.so
	gcc $(CFLAGS) -I$(EVSETS_DIR) -L$(EVSETS_DIR) -Wl,-rpath=$(EVSETS_DIR) \
	-I$(KMOD_DIR) -L$(KMOD_DIR) -Wl,-rpath=$(KMOD_DIR) \
  -o libllc_prime_probe.so llc_prime_probe.c -shared -fpic -lm -levsets -lkmod_driver

$(KMOD_DIR)/libkmod_driver.so:
	cd $(KMOD_DIR) && make

$(EVSETS_DIR)/libevsets.so:
	cd $(EVSETS_DOR) && make

clean:
	rm libllc_prime_probe.so
