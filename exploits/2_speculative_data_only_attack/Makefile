APP_DIR := $(patsubst %/,%,$(dir $(abspath $(lastword $(MAKEFILE_LIST)))))
LLC_PP_DIR := $(APP_DIR)/../common/cache_channel/
MATRIX_LIB_DIR := $(APP_DIR)/../common/matrix/
ENVPREP_DIR := $(APP_DIR)/../common/envprep/
MEMPREP_DIR := $(APP_DIR)/../common/memprep/
MEMWRITE_DIR := $(APP_DIR)/../common/memwrite/
SPECEX_UTILS_DIR := $(APP_DIR)/../common/specex_utils/
SPECEX_LEAKS_DIR := $(APP_DIR)/../common/specex_leaks/
KMOD_DIR := $(APP_DIR)/../../kmod/

CFLAGS := -g -O2 -flto

all: poc

poc: poc.c $(MATRIX_LIB_DIR)/libmatrix.so $(LLC_PP_DIR)/libllc_prime_probe.so $(KMOD_DIR)/libkmod_driver.so $(MEMWRITE_DIR)/memwrite.c $(MEMPREP_DIR)/memprep.c $(ENVPREP_DIR)/envprep.c $(SPECEX_LEAKS_DIR)/specex_leaks.c $(SPECEX_UTILS_DIR)/specex_utils.c config.h
	gcc $(CFLAGS) poc.c -o poc -Wunused-function -Wunused-variable \
    -I$(APP_DIR) \
    -I$(ENVPREP_DIR) $(ENVPREP_DIR)/envprep.c \
    -I$(MEMPREP_DIR) $(MEMPREP_DIR)/memprep.c \
    -I$(MEMWRITE_DIR) $(MEMWRITE_DIR)/memwrite.c \
    -I$(SPECEX_UTILS_DIR) $(SPECEX_UTILS_DIR)/specex_utils.c \
    -I$(SPECEX_LEAKS_DIR) $(SPECEX_LEAKS_DIR)/specex_leaks.c \
    -I$(LLC_PP_DIR) -L$(LLC_PP_DIR) -Wl,-rpath=$(LLC_PP_DIR) \
    -I$(MATRIX_LIB_DIR) -L$(MATRIX_LIB_DIR) -Wl,-rpath=$(MATRIX_LIB_DIR) \
    -I$(KMOD_DIR) -L$(KMOD_DIR) -Wl,-rpath=$(KMOD_DIR) \
    -lmatrix -lllc_prime_probe -lkmod_driver -lpthread -lm

$(MATRIX_LIB_DIR)/libmatrix.so:
	cd $(MATRIX_LIB_DIR) && make

$(LLC_PP_DIR)/libllc_prime_probe.so:
	cd $(LLC_PP_DIR) && make

$(KMOD_DIR)/libkmod_driver.so:
	cd $(KMOD_DIR) && make

clean:
	rm -f poc
